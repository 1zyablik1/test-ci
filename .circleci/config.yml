jobs:
  buildAndroid:
    docker:
      - image: 1zyablik1/unity
      
    steps:
      - run:
          name: git
          command: git clone https://github.com/1zyablik1/test-ci.git /root/project/unityPrj
      - run:
          name: setup display
          command: |
            Xvfb :1 -screen 0 1280x720x24 &
            export DISPLAY=:1
            unity -batchmode -projectPath /unityPrj/ -executeMethod BuildScript.BuildAndroid -quit
      - run:
          name: Display Unity log
          command: cat /root/.config/unity3d/Editor.log
          when: always
      - store_artifacts:
          path: /root/project/unityPrj/Builds/Android/
          destination: Andriod
          
  buildIos:
    working_directory: ~/project
    docker:
      - image: 1zyablik1/unity
      
    steps:
      - run:
          name: git
          command: git clone https://github.com/1zyablik1/test-ci.git /root/project/unityPrj
      - run:
          name: build
          command: |
            Xvfb :1 -screen 0 1280x720x24 &
            export DISPLAY=:1
            unity -batchmode -projectPath /unityPrj/ -executeMethod BuildScript.BuildIos -quit
      - run:
          name: Display Unity log
          command: cat /root/.config/unity3d/Editor.log
          when: always
      - run:
          name: LS
          command: ls ~/project/unityPrj/Builds/iOS/
      - persist_to_workspace:
          root: ./unityPrj
          paths:
            - .
      
  receive:
    macos:
      xcode: "12.5.1"
    steps:
      - attach_workspace:
          at: /tmp/workspace
      - run:
          name: Use artifact
          command: ls /tmp/workspace
      
workflows:
  version: 2
  build-and-deploy:
    jobs:
      - buildIos
      - receive:
          requires:
            - buildIos
      
